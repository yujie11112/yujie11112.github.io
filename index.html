<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç°¡æ˜“éŸ³æ¨‚æ’­æ”¾å™¨ç¤ºç¯„</title>
  <style>
    /* ç°¡æ½”çš„æ¨£å¼ï¼Œæ”¾åœ¨åŒä¸€æª”æ¡ˆæ–¹ä¾¿æ¸¬è©¦ */
    :root {
      --bg: #0f1724;
      --card: #0b1220;
      --accent: #6ee7b7;
      --muted: #9aa6b2;
      --glass: rgba(255,255,255,0.03);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Helvetica Neue", Arial, "Noto Sans TC", sans-serif;
      background: linear-gradient(180deg, #071027 0%, #071523 100%);
      color: #eef6f9;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    .player {
      width: 980px;
      max-width: 98%;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 18px;
    }

    .cover {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      text-align: center;
    }
    .cover img {
      width: 100%;
      height: auto;
      border-radius: 8px;
      display: block;
    }
    .meta {
      margin-top: 12px;
      text-align: left;
    }
    .meta h3 { margin: 0 0 6px 0; font-size: 18px; }
    .meta p { margin: 0; color: var(--muted); font-size: 13px; }

    .controls {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top: 14px;
    }
    .btn {
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.04);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: inherit;
      font-weight: 600;
    }
    .btn:active { transform: translateY(1px); }

    .main {
      padding: 12px 16px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    }

    .progress {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
      margin-top: 12px;
      position: relative;
      cursor: pointer;
    }
    .progress > .bar {
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), #3dd6ff);
      border-radius: 6px;
    }

    .time {
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .playlist {
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .track {
      padding:10px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(255,255,255,0.01);
      cursor:pointer;
    }
    .track.active {
      outline: 2px solid rgba(110,231,183,0.12);
      background: linear-gradient(90deg, rgba(110,231,183,0.04), transparent);
    }
    .track .left { display:flex; gap:10px; align-items:center; }
    .track img { width:44px; height:44px; border-radius:6px; object-fit:cover; }
    .track .title { font-size:14px; }
    .track .artist { font-size:12px; color:var(--muted); }

    .right-panel {
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    canvas {
      width: 100%;
      height: 140px;
      border-radius:8px;
      background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.05));
    }

    .bottom {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:10px;
    }
    .volume { display:flex; align-items:center; gap:8px; }
    .small { font-size:12px; color:var(--muted); }
    @media (max-width:760px){
      .player { grid-template-columns: 1fr; }
      canvas { height: 120px; }
    }
  </style>
</head>
<body>
  <div class="player" id="player">
    <div class="cover">
      <img id="coverImg" src="https://picsum.photos/400/400?music" alt="cover">
      <div class="meta">
        <h3 id="trackTitle">ç¤ºç¯„æ­Œæ›² 1</h3>
        <p id="trackArtist">ç¤ºç¯„æ­Œæ‰‹</p>
      </div>

      <div class="controls">
        <button class="btn" id="prevBtn">â® ä¸Šä¸€é¦–</button>
        <button class="btn" id="playBtn">â–¶ï¸ æ’­æ”¾</button>
        <button class="btn" id="nextBtn">â­ ä¸‹ä¸€é¦–</button>
      </div>

      <div class="small" style="margin-top:10px;">æ’­æ”¾æ¸…å–®</div>
      <div class="playlist" id="playlist"></div>
    </div>

    <div class="main">
      <div class="right-panel">
        <canvas id="viz"></canvas>

        <div class="progress" id="progress">
          <div class="bar" id="progressBar"></div>
        </div>
        <div class="time">
          <span id="currentTime">0:00</span>
          <span id="duration">0:00</span>
        </div>

        <div class="bottom">
          <div class="volume">
            <span class="small">ğŸ”Š</span>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
            <span class="small" id="volLabel">80%</span>
          </div>

          <div class="small">è‡ªå‹•æ’­æ”¾ï¼š
            <label style="margin-left:8px">
              <input type="checkbox" id="autoplay" checked> é–‹å•Ÿ
            </label>
          </div>
        </div>

        <!-- éš±è—çš„ HTML5 audio å…ƒç´ ç”± JS æ§åˆ¶ -->
        <audio id="audio"></audio>
      </div>
    </div>
  </div>

  <script>
    // ---------------------
    // ç¯„ä¾‹æ’­æ”¾æ¸…å–®ï¼ˆè«‹è‡ªè¡Œæ›¿æ› src èˆ‡ coverï¼‰
    // ---------------------
    const tracks = [
      {
        title: "SoundHelix Song 1 (ç¤ºç¯„)",
        artist: "SoundHelix",
        src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
        cover: "https://picsum.photos/400/400?random=1"
      },
      {
        title: "SoundHelix Song 2 (ç¤ºç¯„)",
        artist: "SoundHelix",
        src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
        cover: "https://picsum.photos/400/400?random=2"
      },
      {
        title: "æœ¬æ©Ÿç¯„ä¾‹ - å¯æ›¿æ›æˆç›¸å°è·¯å¾‘æˆ–ä¸Šå‚³ URL",
        artist: "ä½ çš„æ­Œæ‰‹",
        src: "demo/song3.mp3",
        cover: "https://picsum.photos/400/400?random=3"
      }
    ];

    // DOM å…ƒç´ 
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const playlistEl = document.getElementById('playlist');
    const trackTitle = document.getElementById('trackTitle');
    const trackArtist = document.getElementById('trackArtist');
    const coverImg = document.getElementById('coverImg');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const volumeSlider = document.getElementById('volume');
    const volLabel = document.getElementById('volLabel');
    const autoplayCheckbox = document.getElementById('autoplay');

    let currentIndex = 0;
    let isPlaying = false;

    // åˆå§‹åŒ–æ’­æ”¾æ¸…å–®é …ç›®
    function renderPlaylist() {
      playlistEl.innerHTML = '';
      tracks.forEach((t, i) => {
        const item = document.createElement('div');
        item.className = 'track' + (i === currentIndex ? ' active' : '');
        item.dataset.index = i;
        item.innerHTML = `
          <div class="left">
            <img src="${t.cover}" alt="cover">
            <div>
              <div class="title">${t.title}</div>
              <div class="artist">${t.artist}</div>
            </div>
          </div>
          <div class="duration small">--:--</div>
        `;
        item.addEventListener('click', () => {
          loadTrack(i);
          playAudio();
        });
        playlistEl.appendChild(item);
      });
    }

    // è¼‰å…¥æŒ‡å®šæ›²ç›®ï¼Œä½†ä¸è‡ªå‹•æ’­æ”¾ï¼ˆé™¤éå‘¼å« playAudioï¼‰
    function loadTrack(index) {
      if (index < 0 || index >= tracks.length) return;
      currentIndex = index;
      const t = tracks[index];
      audio.src = t.src;
      trackTitle.textContent = t.title;
      trackArtist.textContent = t.artist;
      coverImg.src = t.cover;
      updateActiveTrack();
    }

    function updateActiveTrack() {
      document.querySelectorAll('.track').forEach(el => {
        el.classList.toggle('active', Number(el.dataset.index) === currentIndex);
      });
    }

    function playAudio() {
      audio.play().then(() => {
        isPlaying = true;
        playBtn.textContent = 'â¸ æš«åœ';
      }).catch(err => {
        // è‹¥å› ç€è¦½å™¨è‡ªå‹•æ’­æ”¾ç­–ç•¥è¢«é˜»æ“‹ï¼Œæ”¹ç‚ºé¡¯ç¤º play æŒ‰éˆ•
        console.warn('æ’­æ”¾è¢«é˜»æ“‹æˆ–ç™¼ç”ŸéŒ¯èª¤ï¼š', err);
        isPlaying = false;
        playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
      });
    }

    function pauseAudio() {
      audio.pause();
      isPlaying = false;
      playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
    }

    playBtn.addEventListener('click', () => {
      if (!audio.src) loadTrack(currentIndex);
      if (isPlaying) pauseAudio();
      else playAudio();
    });

    prevBtn.addEventListener('click', () => {
      currentIndex = (currentIndex - 1 + tracks.length) % tracks.length;
      loadTrack(currentIndex);
      playAudio();
    });

    nextBtn.addEventListener('click', () => {
      currentIndex = (currentIndex + 1) % tracks.length;
      loadTrack(currentIndex);
      playAudio();
    });

    // é€²åº¦æ›´æ–°
    audio.addEventListener('timeupdate', () => {
      if (audio.duration) {
        const pct = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = pct + '%';
        currentTimeEl.textContent = formatTime(audio.currentTime);
      }
    });

    audio.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(audio.duration || 0);
      // æ›´æ–° playlist é …ç›®é¡¯ç¤ºçš„é•·åº¦ï¼ˆç°¡å–®ä½œæ³•ï¼šç¬¬ä¸€å€‹å¯ç”¨å³å¯ï¼‰
      const durationEls = document.querySelectorAll('.track .duration');
      durationEls.forEach((d) => d.textContent = formatTime(audio.duration || 0));
    });

    audio.addEventListener('ended', () => {
      if (autoplayCheckbox.checked) {
        nextBtn.click();
      } else {
        pauseAudio();
        audio.currentTime = 0;
      }
    });

    // é»æ“Šé€²åº¦æ¢ä»¥è·³è½‰
    progress.addEventListener('click', (e) => {
      const rect = progress.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const pct = x / rect.width;
      if (audio.duration) audio.currentTime = pct * audio.duration;
    });

    // éŸ³é‡æ§åˆ¶
    volumeSlider.addEventListener('input', (e) => {
      audio.volume = Number(e.target.value);
      volLabel.textContent = Math.round(audio.volume * 100) + '%';
    });

    // æ ¼å¼åŒ–æ™‚é–“ï¼ˆç§’ -> M:SSï¼‰
    function formatTime(sec) {
      if (!sec || !isFinite(sec)) return '0:00';
      sec = Math.floor(sec);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ':' + (s < 10 ? '0' + s : s);
    }

    // åˆå§‹è¨­å®š
    renderPlaylist();
    loadTrack(0);
    audio.volume = Number(volumeSlider.value);
    volLabel.textContent = Math.round(audio.volume * 100) + '%';

    // --------------------------
    // Web Audio è¦–è¦ºåŒ–ï¼ˆç°¡å–®é »è­œ/æ³¢å½¢ï¼‰
    // --------------------------
    const canvas = document.getElementById('viz');
    const ctx = canvas.getContext('2d');

    // èª¿æ•´ canvas å¤§å°ä»¥æ”¯æ´é«˜ DPI
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = canvas.clientWidth * dpr;
      canvas.height = canvas.clientHeight * dpr;
      ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let audioCtx, analyser, sourceNode, dataArray, rafId;

    function setupVisualizer() {
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      // å°‡ <audio> å…ƒä»¶çš„è¼¸å‡ºé€£åˆ° analyser
      sourceNode = audioCtx.createMediaElementSource(audio);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
      draw();
    }

    function draw() {
      if (!analyser) return;
      analyser.getByteTimeDomainData(dataArray);

      // æ¸…ç•«å¸ƒ
      ctx.clearRect(0, 0, canvas.clientWidth, canvas.clientHeight);

      // ç•«ç°¡å–®æ³¢å½¢
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgba(110,231,183,0.9)';
      ctx.beginPath();

      const sliceWidth = canvas.clientWidth / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 128.0; // 0..2
        const y = (v * canvas.clientHeight) / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(canvas.clientWidth, canvas.clientHeight / 2);
      ctx.stroke();

      rafId = requestAnimationFrame(draw);
    }

    // ç•¶ä½¿ç”¨è€…äº’å‹•æ™‚å•Ÿå‹•éŸ³è¨Šï¼ˆé¿å…è¢«ç€è¦½å™¨é˜»æ“‹ï¼‰
    document.getElementById('player').addEventListener('click', () => {
      if (!audioCtx) {
        try {
          setupVisualizer();
        } catch (e) {
          console.warn('ç„¡æ³•å»ºç«‹ AudioContextï¼š', e);
        }
      }
    }, { once: true });

    // å¦‚æœé é¢é›¢é–‹æˆ–é—œé–‰ï¼Œæ¸…ç† requestAnimationFrame
    window.addEventListener('beforeunload', () => {
      if (rafId) cancelAnimationFrame(rafId);
      if (audioCtx && audioCtx.close) audioCtx.close();
    });

    // ---- å¯é¸ï¼šæ”¯æ´éµç›¤ç©ºç™½éµåˆ‡æ›æ’­æ”¾ ----
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        playBtn.click();
      }
    });

  </script>
</body>
</html>
